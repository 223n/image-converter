# 画像変換ツール プロジェクト引き継ぎドキュメント

## プロジェクト概要

このプロジェクトは、JPG、PNG、HEIC、HEIFなどの画像ファイルをWebPとAVIFフォーマットに変換するGoアプリケーションです。
ローカルモードとリモートモード（SSH経由）の両方をサポートし、並列処理による高速変換を実現しています。

### 主な機能

- 複数フォーマットの画像をWebPとAVIFに変換
- ローカルディレクトリとリモートサーバーでの変換
- 並列処理によるパフォーマンス最適化
- 組み込みFTP/SSHサーバー機能
- 詳細な進捗表示と統計情報

## プロジェクト構造

クリーンアーキテクチャベースの新しいディレクトリ構造に完全にリファクタリングしました：

```bash
image-converter/
├── cmd/
│   └── image-converter/         # メインアプリケーションのエントリーポイント
│       └── main.go
├── internal/                    # 非公開パッケージ
│   ├── config/                  # 設定関連
│   │  ├── config.go
│   │  └── defaults.go
│   ├── converter/               # 変換処理
│   │  ├── avif.go
│   │  ├── convert.go
│   │  └── webp.go
│   ├── local/                   # ローカルモード処理
│   │  ├── finder.go
│   │  ├── process.go
│   │  └── service.go
│   ├── remote/                  # リモート処理
│   │  ├── client.go
│   │  ├── operations.go
│   │  └── service.go
│   ├── server/                  # サーバー機能
│   │  ├── ftp.go
│   │  ├── server.go
│   │  └── ssh.go
│   └── utils/                   # ユーティリティ
│       ├── files.go
│       ├── logging.go
│       └── progress.go
├── pkg/                         # 公開パッケージ
│   └── imageutils/              # 画像処理ユーティリティ
│       ├── formats.go
│       ├── metadata.go
│       └── validation.go
├── configs/                     # 設定ファイル
├── docs/                        # ドキュメント
├── scripts/                     # スクリプト
│  ├── build.sh
│  ├── clean-build.sh
│  ├── install-deps.sh
│  ├── lint.sh
│  ├── run-tests.sh
│  └── run.sh
└── bin/                         # ビルド成果物
```

## 技術的詳細

### 主要な依存関係

- `github.com/Kagami/go-avif` - AVIF変換
- `github.com/chai2010/webp` - WebP変換の代替
- `github.com/jdeng/goheif` - HEIF/HEIC画像のデコード
- `github.com/pkg/sftp` - SFTPによるファイル転送
- `golang.org/x/crypto/ssh` - SSH機能
- `gopkg.in/yaml.v3` - YAML設定ファイルの解析

### 重要な技術的決定

1. **WebP変換方法**:
   - 優先順位:
     1. `cwebp`コマンド（外部ツール）
     2. `chai2010/webp`ライブラリ

2. **AVIF変換**:
   - libaomライブラリに依存
   - 品質範囲: 1-63（標準WebPの0-100とは異なる）

3. **リトライ機能**:
   - リモート処理では接続障害に対応するリトライ機能を実装
   - 指数バックオフ方式で待機時間を調整

4. **バッチ処理**:
   - リモートモードでは安定性のためにバッチ処理（デフォルト20ファイル）
   - バッチ間に休止期間を設けてSSH接続を安定化

## リファクタリングの内容

コードをリファクタリングするために以下の主な改善を行いました：

1. **関心の分離**:
   - 各モジュールが明確な単一責任を持つよう分割
   - インターフェイスを通じた依存性の逆転
   - 設定値は一貫してポインターで渡すように統一

2. **複雑性の低減**:
   - 認知的複雑性と循環的複雑性の高い関数を複数の小さな関数に分割
     - とくに `Client.DownloadFile`、`Client.UploadFile`、`ImageConverter.Convert`、`SSHService.setupSSHKeys` などを改善
   - 早期リターンパターンを使用して条件分岐のネストを減少

3. **エラーハンドリングの改善**:
   - 詳細なエラーメッセージとコンテキスト
   - エラーの適切な伝播と処理

4. **共通ユーティリティの抽出**:
   - ログ機能を `LogManager` にカプセル化
   - ファイル処理機能を専用関数として抽出

5. **コーディング規約とベストプラクティスの適用**:
   - ブランクインポートに適切なコメントを追加
   - 未使用パラメーターは `_` で明示
   - 適切なドキュメントコメントの形式（エクスポートされた要素の説明など）

## 残存課題

1. **テストカバレッジ**:
   - ユニットテストが不足しており、追加が必要
   - エッジケースのテストが必要

2. **エラー処理の強化**:
   - パニックリカバリー機能の追加が望ましい
   - システムレベルのエラーハンドリングの強化

3. **パフォーマンス最適化**:
   - リモート変換処理のさらなる効率化
   - バッチサイズの動的調整機能

4. **依存関係管理**:
   - 外部コマンド（cwebp）への依存の改善
   - ライブラリのバージョン更新と互換性確認

## 改善点のまとめ

### すでに実装された改善

1. **構造的な改善**:
   - クリーンアーキテクチャに基づいたディレクトリ構成
   - 一貫したポインター型の使用による設定管理
   - 複雑な関数の分割と単一責任の原則の適用

2. **品質改善**:
   - Lintの警告解消
   - エラーハンドリングの強化
   - コードの可読性向上

### 今後の開発方針

1. **テスト戦略**:
   - ユニットテストの追加
   - テストカバレッジの向上
   - モックを使用した依存関係のテスト

2. **UI改善**:
   - より詳細な進捗表示
   - 変換結果のサマリービュー

3. **機能拡張**:
   - 追加フォーマットのサポート
   - 変換品質の自動最適化
   - メタデータ保持オプション

## 次のステップ

1. テストスイートの実装
2. ビルドとCI/CDパイプラインの設定
3. パフォーマンスのプロファイリングとベンチマーク
4. ドキュメントの完成
5. パッケージング方法の検討（Docker、バイナリリリースなど）

このプロジェクトは、コードの品質と保守性に重点を置いて改善を行いました。今後も継続的なリファクタリングとテスト強化を行うことで、より堅牢なアプリケーションになることを目指しています。
