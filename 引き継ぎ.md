# 画像変換ツール プロジェクト引き継ぎドキュメント

## プロジェクト概要

このプロジェクトは、JPG、PNG、HEIC、HEIFなどの画像ファイルをWebPとAVIFフォーマットに変換するGoアプリケーションです。
ローカルモードとリモートモード（SSH経由）の両方をサポートし、並列処理による高速変換を実現しています。

### 主な機能

- 複数フォーマットの画像をWebPとAVIFに変換
- ローカルディレクトリとリモートサーバーでの変換
- 並列処理によるパフォーマンス最適化
- 組み込みFTP/SSHサーバー機能
- 詳細な進捗表示と統計情報

## プロジェクト構造

既存の構造から、以下のようなクリーンアーキテクチャベースの新しいディレクトリ構造にリファクタリングしました：

```bash
image-converter/
├── cmd/
│   └── image-converter/         # メインアプリケーションのエントリーポイント
│       └── main.go
├── internal/                    # 非公開パッケージ
│   ├── config/                  # 設定関連
│   │  ├── config.go
│   │  └── defaults.go
│   ├── converter/               # 変換処理
│   │  ├── avif.go
│   │  ├── convert.go
│   │  └── webp.go
│   ├── local/                   # ローカルモード処理
│   │  ├── finder.go
│   │  ├── process.go
│   │  └── service.go
│   ├── remote/                  # リモート処理
│   │  ├── client.go
│   │  ├── operations.go
│   │  └── service.go
│   ├── server/                  # サーバー機能
│   │  ├── ftp.go
│   │  ├── server.go
│   │  └── ssh.go
│   └── utils/                   # ユーティリティ
│       ├── files.go
│       ├── logging.go
│       └── progress.go
├── pkg/                         # 公開パッケージ
│   └── imageutils/              # 画像処理ユーティリティ
│       ├── formats.go
│       ├── metadata.go
│       └── validation.go
├── configs/                     # 設定ファイル
├── docs/                        # ドキュメント
├── scripts/                     # スクリプト
│  ├── build.sh
│  ├── clean-build.sh
│  ├── install-deps.sh
│  ├── lint.sh
│  ├── run-tests.sh
│  └── run.sh
└── bin/                         # ビルド成果物
```

## 技術的詳細

### 主要な依存関係

- `github.com/Kagami/go-avif` - AVIF変換
- `github.com/chai2010/webp` - WebP変換の代替
- `github.com/jdeng/goheif` - HEIF/HEIC画像のデコード
- `github.com/pkg/sftp` - SFTPによるファイル転送
- `golang.org/x/crypto/ssh` - SSH機能
- `gopkg.in/yaml.v3` - YAML設定ファイルの解析

### 重要な技術的決定

1. **WebP変換方法**:
   - 優先順位:
     1. `cwebp`コマンド（外部ツール）
     2. `chai2010/webp`ライブラリ

2. **AVIF変換**:
   - libaomライブラリに依存
   - 品質範囲: 1-63（標準WebPの0-100とは異なる）

3. **リトライ機能**:
   - リモート処理では接続障害に対応するリトライ機能を実装
   - 指数バックオフ方式で待機時間を調整

4. **バッチ処理**:
   - リモートモードでは安定性のためにバッチ処理（デフォルト20ファイル）
   - バッチ間に休止期間を設けてSSH接続を安定化

## リファクタリングの方針

既存のコードをリファクタリングする際に従った主な方針：

1. **関心の分離**:
   - 各モジュールが明確な単一責任を持つよう分割
   - インターフェイスを通じた依存性の逆転

2. **複雑性の低減**:
   - 認知的複雑性と循環的複雑性の高い関数を分割
   - 小さく、テスト可能な関数に分解

3. **エラーハンドリングの改善**:
   - 詳細なエラーメッセージとコンテキスト
   - エラーの適切な伝播

4. **共通ユーティリティの抽出**:
   - 複数の場所で使用される機能を共通ユーティリティとして抽出

## 改善のヒント

今後のプロジェクト改善のためのヒント：

1. **テストカバレッジの向上**:
   - 各モジュールに対するユニットテスト
   - インテグレーションテスト

2. **エラー処理の強化**:
   - パニックリカバリー機能の追加
   - より詳細なエラーレポート

3. **パフォーマンス最適化**:
   - 変換処理のさらなる最適化
   - メモリ使用量の削減

4. **新機能候補**:
   - 画像の事前検証とフィルタリング
   - 変換結果の自動最適化
   - バッチサイズの動的調整

## 困難だった点

プロジェクトで、とくに困難だった点と解決策：

1. **AVIF変換の品質設定**:
   - 問題: AVIF変換でのオプションエラー（`bad quality value`）
   - 解決策: 品質値を1-63の範囲に自動調整する検証を追加

2. **リモート接続の安定性**:
   - 問題: `connection lost`エラーによる処理の中断
   - 解決策: リトライ機能、バッチ処理、接続再確立機能の実装

3. **コードの複雑性**:
   - 問題: Reviveによる複雑性警告（認知的複雑性、循環的複雑性）
   - 解決策: 大きな関数を小さな関数に分割、責任範囲を明確化

## 今後の展望

このプロジェクトはまだ開発途中であり、新しいClaudeが取り組むべき主な課題は：

1. 未実装コンポーネントの実装完了
2. 各コンポーネント間のインテグレーション
3. テスト戦略の設計と実装
4. 実践的なユースケースでのパフォーマンス最適化

## 参考資料

- 既存の設計文書とコード
- [go-avif](https://github.com/Kagami/go-avif) ドキュメント
- [WebP Tools](https://developers.google.com/speed/webp/docs/using) ドキュメント
- Go言語のクリーンアーキテクチャに関する資料
