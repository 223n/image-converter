# リモート変換ガイド

この文書では、画像変換ツールを使用してリモートサーバー上の画像を変換する方法について詳しく説明します。

## 目次

- [リモート変換ガイド](#リモート変換ガイド)
  - [目次](#目次)
  - [リモートモードの概要](#リモートモードの概要)
  - [前提条件](#前提条件)
  - [設定方法](#設定方法)
  - [SSH認証設定](#ssh認証設定)
    - [SSH Agent認証（推奨）](#ssh-agent認証推奨)
    - [秘密鍵ファイル認証](#秘密鍵ファイル認証)
    - [ホスト鍵の検証](#ホスト鍵の検証)
  - [リモート変換の実行](#リモート変換の実行)
    - [コマンドラインから有効化](#コマンドラインから有効化)
    - [設定ファイルで有効化](#設定ファイルで有効化)
    - [ドライランによる検証](#ドライランによる検証)
  - [詳細なログ](#詳細なログ)
  - [トラブルシューティング](#トラブルシューティング)
    - [接続に関する問題](#接続に関する問題)
    - [認証の問題](#認証の問題)
    - [ファイルアクセスの問題](#ファイルアクセスの問題)
  - [パフォーマンスチューニング](#パフォーマンスチューニング)
    - [バッチサイズの調整](#バッチサイズの調整)
    - [タイムアウト設定](#タイムアウト設定)
    - [ワーカー数の調整](#ワーカー数の調整)
  - [ベストプラクティス](#ベストプラクティス)

## リモートモードの概要

リモートモードでは、SSHプロトコルを使用してリモートサーバーに接続し、以下の処理を行います：

1. リモートサーバー上で画像ファイルを検索
2. 対象ファイルをローカルにダウンロード
3. ローカルで変換処理を実行
4. 変換済みファイル（WebP/AVIF）をリモートサーバーにアップロード

これにより、サーバー上に変換ツールをインストールすることなく、リモートサーバー上の画像を最適化できます。

## 前提条件

リモートモードを使用するには、以下の条件を満たす必要があります：

1. リモートサーバーへのSSHアクセス権限
2. SSH接続に使用する秘密鍵/公開鍵ペア、またはパスワード認証の設定
3. リモートサーバー上のファイルへの読み書き権限

## 設定方法

リモート接続の設定は、設定ファイル（`config.yml`）の `remote` セクションで行います：

```yaml
remote:
  # リモート変換を有効にする
  enabled: true
  # リモートサーバーのホスト名またはIP
  host: "example.com"
  # SSHポート（通常は22）
  port: 22
  # リモートユーザー名
  user: "webuser"
  # 秘密鍵のパス（空の場合はSSH Agentを使用）
  key_path: "~/.ssh/id_rsa"
  # 既知のホストファイルのパス（空の場合は検証を無効化）
  known_hosts: "~/.ssh/known_hosts"
  # リモートサーバー上の変換対象パス
  remote_path: "/var/www/html/images"
  # SSH Agentを使用するかどうか
  use_ssh_agent: true
  # タイムアウト（秒）
  timeout: 60
```

## SSH認証設定

### SSH Agent認証（推奨）

SSH Agentを使用した認証が、もっとも便利で安全な方法です：

1. SSH Agentが実行されていることを確認：
        ```bash
        eval "$(ssh-agent -s)"
        ```

2. 秘密鍵をSSH Agentに追加：
        ```bash
        ssh-add ~/.ssh/id_rsa
        ```

3. 設定ファイルで `use_ssh_agent: true` を設定

### 秘密鍵ファイル認証

SSH Agentを使用しない場合、秘密鍵ファイルを直接指定することもできます：

1. 設定ファイルで `key_path` に秘密鍵ファイルのパスを指定
2. `use_ssh_agent: false` を設定

### ホスト鍵の検証

セキュリティ向上のため、`known_hosts` ファイルを指定して接続先のホスト鍵を検証することを推奨します：

```yaml
remote:
  # ...他の設定...
  known_hosts: "~/.ssh/known_hosts"
```

初回接続時に正しいホスト鍵を取得するには、事前に手動でSSH接続を試みてください：

```bash
ssh webuser@example.com
```

これにより、ホスト鍵が `~/.ssh/known_hosts` に追加されます。

## リモート変換の実行

リモートモードを実行するには、コマンドラインオプションまたは設定ファイルを使用します：

### コマンドラインから有効化

```bash
./image-converter -remote
```

### 設定ファイルで有効化

```yaml
remote:
  enabled: true
  # ...他の設定...
```

### ドライランによる検証

実際の変換を行わずにファイル検索のみを実行することでテストできます：

```bash
./image-converter -remote -dry-run
```

## 詳細なログ

リモート変換中の詳細なログは、以下の情報を含んでいます：

- ファイル検索結果と対象ファイル数
- ダウンロード進捗状況
- 変換処理の進捗状況
- アップロード進捗状況
- エラーやファイルのスキップに関する情報

ログファイルは処理開始時間を含むファイル名で保存されます：

```bash
remote-converter_20250228_120000.log
```

## トラブルシューティング

### 接続に関する問題

**問題**: `connection lost` や接続タイムアウトエラー

**解決策**:

- `timeout` 値を増やす（60秒以上推奨）
- バッチサイズを減らす（デフォルト: 20）
- ネットワーク接続を確認する

### 認証の問題

**問題**: `authentication failed` エラー

**解決策**:

- SSH Agentの実行と鍵の登録を確認
- 秘密鍵のパーミッションを確認（600が推奨）
- リモートユーザー名が正しいか確認

### ファイルアクセスの問題

**問題**: ファイルのダウンロードや変換後のアップロードエラー

**解決策**:

- リモートユーザーに適切なファイル読み書き権限があるか確認
- リモートパスが正しいか確認
- ディスク容量に問題がないか確認

## パフォーマンスチューニング

リモートモードのパフォーマンスを最適化するためのヒント：

### バッチサイズの調整

大量のファイルを処理する場合、バッチサイズによってパフォーマンスと安定性のバランスを調整できます：

```yaml
# より安定したSSH接続のための小さいバッチ
batch_size: 10  # デフォルトは20
```

注: この設定は現在設定ファイルではなくコード内で定義されています。将来的には設定ファイルからカスタマイズ可能になる予定です。

### タイムアウト設定

低速または不安定なネットワーク接続の場合、タイムアウト値を大きくしてください：

```yaml
remote:
  # ...他の設定...
  timeout: 120  # 秒単位
```

### ワーカー数の調整

ローカルマシンのスペックに応じて、並列処理ワーカー数を調整してください：

```yaml
conversion:
  workers: 4  # コア数に合わせて調整
```

## ベストプラクティス

リモート変換を効率的かつ安全に使用するためのベストプラクティス：

1. **対象ディレクトリを限定する**: 小さなディレクトリから始めて、徐々に範囲を広げることで問題を早期に発見できます

2. **ドライランでテスト**: 実際の変換前に `-dry-run` オプションでテストすることをオススメします

3. **SSH鍵認証を使用する**: パスワード認証よりもSSH鍵認証が安全です

4. **定期的なバックアップ**: 変換処理の前に重要なファイルのバックアップを取ることをオススメします

5. **ログの確認**: 処理後にログファイルを確認し、エラーやスキップされたファイルを特定してください

6. **時間帯の配慮**: サーバー負荷が少ない時間帯に実行することで、サーバーのパフォーマンスへの影響を最小限に抑えられます
